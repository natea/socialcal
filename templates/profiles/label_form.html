{% load widget_tweaks %}
{% load static %}

{% block title %}{% if label %}Edit{% else %}Add{% endif %} Label{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/label_form.css' %}">
{% endblock %}

{% block content %}
<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title">{% if label %}Edit{% else %}Add{% endif %} Label</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <form method="post" class="label-form" action="{% if label %}{% url 'profiles:edit_label' label.id %}{% else %}{% url 'profiles:add_label' %}{% endif %}">
        <div class="modal-body">
            {% csrf_token %}
            <div class="mb-3">
                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                {{ form.name|add_class:"form-control" }}
                <div class="invalid-feedback"></div>
            </div>
            <div class="mb-4">
                <label class="form-label d-block">{{ form.color.label }}</label>
                <div class="color-radio-group">
                    {% for choice in form.color.field.choices %}
                        <div class="color-option">
                            <input type="radio" name="{{ form.color.name }}" value="{{ choice.0 }}" 
                                   id="{{ form.color.auto_id }}_{{ forloop.counter0 }}"
                                   {% if form.color.value == choice.0 %}checked{% endif %}>
                            <label for="{{ form.color.auto_id }}_{{ forloop.counter0 }}" 
                                   style="background-color: {{ choice.0 }};"
                                   title="{{ choice.1 }}"
                                   tabindex="0">
                            </label>
                        </div>
                    {% endfor %}
                </div>
                <div class="invalid-feedback"></div>
            </div>
            <div class="alert alert-danger d-none" role="alert"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.label-form');
    
    if (form) {
        // Add keyboard navigation for color options
        form.querySelectorAll('.color-option label').forEach(label => {
            label.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const radio = this.previousElementSibling;
                    radio.checked = true;
                    radio.focus();
                }
            });
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Clear previous error states
            form.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            form.querySelectorAll('.invalid-feedback').forEach(el => {
                el.textContent = '';
            });
            const alertBox = form.querySelector('.alert-danger');
            alertBox.classList.add('d-none');
            alertBox.textContent = '';
            
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                    if (modal) {
                        modal.hide();
                    }
                    // Show success message
                    if (window.showToast) {
                        window.showToast(data.message);
                    }
                    // Reload the page to show the updated label
                    window.location.reload();
                } else {
                    // Handle validation errors
                    Object.entries(data.errors).forEach(([field, errors]) => {
                        const input = form.querySelector(`[name="${field}"]`);
                        if (input) {
                            const container = input.closest('.mb-3, .mb-4');
                            if (container) {
                                container.querySelector('.invalid-feedback').textContent = errors.join(' ');
                                container.classList.add('is-invalid');
                            }
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const alertBox = form.querySelector('.alert-danger');
                alertBox.textContent = 'An error occurred while saving the label. Please try again.';
                alertBox.classList.remove('d-none');
            });
        });
    }
});
</script>
{% endblock %} 